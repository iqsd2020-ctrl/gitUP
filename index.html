<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GIT UP</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Fira+Code:wght@400;500&display=swap');

    :root{
      --bg:#0d1117;
      --card:#161b22;
      --border:#30363d;
      --text:#c9d1d9;
      --muted:#8b949e;
      --accent:#2f81f7;
      --ok:#3fb950;
      --warn:#d29922;
      --err:#f85149;
    }

    html,body{height:100%;}
    body{background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    code, pre, .mono{font-family:"Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    /* منع تكبير iOS عند التركيز */
    input, button, select, textarea{font-size:16px;}
    .card{background:var(--card);border:1px solid var(--border);}
    .btn{border:1px solid var(--border);background:#21262d;}
    .btn:hover{background:#2d333b;}
    .btn-primary{background:var(--accent);border-color:transparent;color:white;}
    .btn-primary:hover{filter:brightness(1.05);}
    .btn-danger{background:var(--err);border-color:transparent;color:white;}
    .btn-danger:hover{filter:brightness(1.05);}
    .pill{border:1px solid var(--border);background:#0b1220;}
    .divider{border-top:1px solid var(--border);}
    .scrollbar::-webkit-scrollbar{height:10px;width:10px;}
    .scrollbar::-webkit-scrollbar-thumb{background:#2d333b;border-radius:999px;}
  </style>
</head>

<body>
  <!-- Mobile backdrop -->
  <div id="backdrop" class="fixed inset-0 bg-black/60 z-40 hidden" onclick="toggleSidebar(false)"></div>

  <div class="min-h-screen flex flex-col md:flex-row">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed z-50 inset-y-0 right-0 w-[86vw] max-w-[320px] md:static md:w-80 transform translate-x-full md:translate-x-0 transition-transform duration-200">
      <div class="h-full card rounded-none md:rounded-l-2xl overflow-hidden flex flex-col">
        <div class="p-4 flex items-center justify-between gap-2 border-b border-[var(--border)]">
          <div class="flex items-center gap-2">
            <i class="fab fa-github text-xl"></i>
            <span class="font-bold">GitHub Manager Ultra</span>
          </div>
          <button class="md:hidden btn rounded-xl px-3 py-2" onclick="toggleSidebar(false)" aria-label="إغلاق">
            <i class="fas fa-xmark"></i>
          </button>
        </div>

        <div class="p-4 space-y-3">
          <div class="text-xs text-[var(--muted)] font-bold uppercase tracking-widest">المصادقة</div>

          <label class="text-sm block">Personal Access Token</label>
          <input id="tokenInput" type="password" placeholder="ghp_xxx أو github_pat_xxx"
                 class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"/>

          <div class="flex gap-2">
            <button class="btn-primary rounded-2xl px-4 py-3 flex-1 font-bold" onclick="validateToken()">
              <i class="fas fa-shield-halved ml-2"></i>تأكيد التوكن
            </button>
            <button class="btn rounded-2xl px-4 py-3" onclick="clearToken()" title="حذف التوكن">
              <i class="fas fa-trash"></i>
            </button>
          </div>

          <div id="userBox" class="hidden card rounded-2xl p-3">
            <div class="flex items-center gap-3">
              <img id="userAvatar" class="w-10 h-10 rounded-full border border-[var(--border)]" alt="avatar"/>
              <div class="min-w-0">
                <div class="font-bold truncate" id="userLogin"></div>
                <div class="text-xs text-[var(--muted)] truncate" id="userName"></div>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-3 gap-2 text-center text-xs">
              <div class="pill rounded-xl py-2">
                <div class="font-bold" id="statRepos">-</div>
                <div class="text-[var(--muted)]">Repos</div>
              </div>
              <div class="pill rounded-xl py-2">
                <div class="font-bold" id="statFollowers">-</div>
                <div class="text-[var(--muted)]">Followers</div>
              </div>
              <div class="pill rounded-xl py-2">
                <div class="font-bold" id="statFollowing">-</div>
                <div class="text-[var(--muted)]">Following</div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="p-4 space-y-3 flex-1 overflow-hidden">
          <div class="flex items-center justify-between">
            <div class="text-xs text-[var(--muted)] font-bold uppercase tracking-widest">المستودعات</div>
            <button class="btn rounded-xl px-3 py-2 text-sm" onclick="loadRepos()" title="تحديث">
              <i class="fas fa-rotate"></i>
            </button>
          </div>

          <input id="repoSearch" type="text" placeholder="بحث..."
                 class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"/>

          <div id="reposList" class="h-full overflow-auto pr-1 scrollbar space-y-2"></div>
        </div>

        <div class="p-4 border-t border-[var(--border)] flex items-center justify-between text-xs text-[var(--muted)]">
          <span class="truncate">LocalStorage</span>
          <span id="apiHint" class="truncate"></span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 md:mr-0">
      <!-- Topbar -->
      <div class="sticky top-0 z-30 backdrop-blur bg-[var(--bg)]/80 border-b border-[var(--border)]">
        <div class="px-4 py-3 flex items-center justify-between gap-2">
          <button class="md:hidden btn rounded-xl px-3 py-2" onclick="toggleSidebar(true)" aria-label="فتح القائمة">
            <i class="fas fa-bars"></i>
          </button>

          <div class="min-w-0 flex-1">
            <div class="text-xs text-[var(--muted)]">المستودع الحالي</div>
            <div class="font-bold truncate" id="currentRepo">—</div>
          </div>

          <div class="hidden sm:flex items-center gap-2">
            <button class="btn rounded-xl px-3 py-2" onclick="downloadZipDirect()" title="تنزيل ZIP مباشر">
              <i class="fas fa-file-zipper ml-2"></i>ZIP مباشر
            </button>
            <button class="btn rounded-xl px-3 py-2" onclick="downloadZipLocalUI()" title="تنزيل ZIP محلي (للخاص أو عند فشل المباشر)">
              <i class="fas fa-box-archive ml-2"></i>ZIP محلي
            </button>
            <button class="btn-danger rounded-xl px-3 py-2" onclick="wipeRepoCommit()" title="مسح المستودع (Commit)">
              <i class="fas fa-broom ml-2"></i>Wipe
            </button>
          </div>
        </div>

        <!-- Mobile quick actions -->
        <div class="sm:hidden px-4 pb-3 grid grid-cols-2 gap-2">
          <button class="btn rounded-2xl px-4 py-3 flex-1" onclick="downloadZipDirect()">
            <i class="fas fa-file-zipper ml-2"></i>ZIP مباشر
          </button>
          <button class="btn rounded-2xl px-4 py-3 flex-1" onclick="downloadZipLocalUI()">
            <i class="fas fa-box-archive ml-2"></i>ZIP محلي
          </button>
          <button class="btn-danger rounded-2xl px-4 py-3 flex-1" onclick="wipeRepoCommit()">
            <i class="fas fa-broom ml-2"></i>Wipe
          </button>
        </div>
      </div>

      <div class="p-4 space-y-4">
        <!-- Upload Card -->
        <section class="card rounded-2xl p-4">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="font-bold text-lg">رفع مشروع</div>
              <div class="text-sm text-[var(--muted)]">Commit واحد + مسارات مجلدات + مؤشرات تقدم</div>
            </div>
            <div class="text-xs text-[var(--muted)] mono" id="branchInfo">—</div>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div class="space-y-3">
              <label class="text-sm font-bold">اختيار ملفات</label>
              <input id="fileInput" type="file" multiple
                     class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white"/>

              <label class="text-sm font-bold">اختيار مجلد (يدعم المسارات)</label>
              <input id="folderInput" type="file" webkitdirectory directory multiple
                     class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white"/>

              <label class="text-sm font-bold">رفع ZIP</label>
              <input id="zipInput" type="file" accept=".zip"
                     class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white"/>

              <div class="flex items-center gap-2">
                <input id="stripZipRoot" type="checkbox" class="w-4 h-4">
                <label for="stripZipRoot" class="text-sm">إزالة مجلد الجذر من ZIP (إن وُجد)</label>
              </div>
            </div>

            <div class="space-y-3">
              <label class="text-sm font-bold">رسالة الـ Commit</label>
              <input id="commitMessage" type="text" placeholder="Update project"
                     class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"/>

              <div class="flex items-center gap-2">
                <input id="wipeBeforeUpload" type="checkbox" class="w-4 h-4">
                <label for="wipeBeforeUpload" class="text-sm font-bold text-[var(--warn)]">Wipe قبل الرفع (يستبدل كل الملفات)</label>
              </div>

              <div class="grid grid-cols-2 gap-2">
              <button id="btnUpload" class="btn-primary rounded-2xl px-4 py-4 w-full font-bold text-lg disabled:opacity-60 disabled:cursor-not-allowed" onclick="startUpload()">
                <i class="fas fa-cloud-arrow-up ml-2"></i>بدء الرفع
              </button>
              <button id="btnStop" class="btn rounded-2xl px-4 py-4 w-full font-bold text-lg" onclick="stopCurrent()">
                <i class="fas fa-stop ml-2"></i>إيقاف
              </button>
            </div>

              <div id="progressBox" class="hidden">
                <div class="flex justify-between text-xs text-[var(--muted)]">
                  <span id="progressText">—</span>
                  <span class="mono" id="progressCount">0/0</span>
                </div>
                <div class="mt-2 w-full bg-[#0b1220] border border-[var(--border)] rounded-full overflow-hidden">
                  <div id="progressBar" class="h-3 bg-[var(--accent)] w-0 transition-all"></div>
                </div>
              </div>

              <div class="text-xs text-[var(--muted)]">
                ملاحظة: ملفات أكبر من <span class="mono">100MB</span> سيتم رفضها لتجنب مشاكل المتصفح.
              </div>
            </div>
          </div>
        </section>

        <!-- Terminal -->
        <section class="card rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold">السجل</div>
            <button class="btn rounded-xl px-3 py-2 text-sm" onclick="clearLog()"><i class="fas fa-eraser ml-2"></i>مسح</button>
          </div>
          <div id="terminal" class="mt-3 h-44 md:h-56 overflow-auto scrollbar bg-[#0b1220] border border-[var(--border)] rounded-2xl p-3 mono text-sm leading-relaxed"></div>
        </section>
      </div>
    </main>
  </div>

<script>
(() => {
  const STORAGE_KEY = "gh_token_session";
  const MAX_FILE_BYTES = 100 * 1024 * 1024;
  const SMALL_DELAY_MS = 200; // لتخفيف secondary rate limits

  const state = {
    token: localStorage.getItem(STORAGE_KEY) || "",
    user: null,
    repos: [],
    selected: null, // {owner, repo, branch}
    aborter: null,
  };

  const el = {
    sidebar: document.getElementById("sidebar"),
    backdrop: document.getElementById("backdrop"),
    tokenInput: document.getElementById("tokenInput"),
    userBox: document.getElementById("userBox"),
    userAvatar: document.getElementById("userAvatar"),
    userLogin: document.getElementById("userLogin"),
    userName: document.getElementById("userName"),
    statRepos: document.getElementById("statRepos"),
    statFollowers: document.getElementById("statFollowers"),
    statFollowing: document.getElementById("statFollowing"),
    repoSearch: document.getElementById("repoSearch"),
    reposList: document.getElementById("reposList"),
    currentRepo: document.getElementById("currentRepo"),
    branchInfo: document.getElementById("branchInfo"),
    apiHint: document.getElementById("apiHint"),

    fileInput: document.getElementById("fileInput"),
    folderInput: document.getElementById("folderInput"),
    zipInput: document.getElementById("zipInput"),
    stripZipRoot: document.getElementById("stripZipRoot"),
    commitMessage: document.getElementById("commitMessage"),
    wipeBeforeUpload: document.getElementById("wipeBeforeUpload"),
    btnUpload: document.getElementById("btnUpload"),
    btnStop: document.getElementById("btnStop"),

    progressBox: document.getElementById("progressBox"),
    progressText: document.getElementById("progressText"),
    progressCount: document.getElementById("progressCount"),
    progressBar: document.getElementById("progressBar"),

    terminal: document.getElementById("terminal"),
  };

  // --- UI helpers (safe text only) ---
  const nowTime = () => new Date().toLocaleTimeString([], {hour12:false});
  function log(msg, level="info"){
    const row = document.createElement("div");
    const time = document.createElement("span");
    time.className = "text-[var(--muted)]";
    time.textContent = `[${nowTime()}] `;

    const text = document.createElement("span");
    text.textContent = msg;

    if(level==="success") text.className="text-[var(--ok)]";
    if(level==="warning") text.className="text-[var(--warn)]";
    if(level==="error") text.className="text-[var(--err)]";

    row.appendChild(time);
    row.appendChild(text);
    el.terminal.appendChild(row);
    el.terminal.scrollTop = el.terminal.scrollHeight;
  }

  function clearLog(){ el.terminal.textContent = ""; }

  function setProgress({visible, text, done, total}){
    if(visible){
      el.progressBox.classList.remove("hidden");
      el.progressText.textContent = text || "";
      el.progressCount.textContent = `${done||0}/${total||0}`;
      const pct = total ? Math.round((done/total)*100) : 0;
      el.progressBar.style.width = `${Math.min(100, Math.max(0,pct))}%`;
    } else {
      el.progressBox.classList.add("hidden");
      el.progressBar.style.width = "0%";
      el.progressText.textContent = "—";
      el.progressCount.textContent = "0/0";
    }
  }

  // --- Sidebar ---
  window.toggleSidebar = function(open){
    const shouldOpen = (open === undefined) ? el.sidebar.classList.contains("translate-x-full") : open;
    if(shouldOpen){
      el.sidebar.classList.remove("translate-x-full");
      el.backdrop.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    } else {
      el.sidebar.classList.add("translate-x-full");
      el.backdrop.classList.add("hidden");
      document.body.style.overflow = "";
    }
  };

  // --- API wrapper with basic rate-limit handling ---
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function apiFetch(endpoint, options = {}, attempt=0){
    const url = `https://api.github.com/${endpoint}`;
    const headers = {
      "Accept": "application/vnd.github+json",
      "X-GitHub-Api-Version": "2022-11-28",
      ...(options.headers || {})
    };
    if(state.token) headers["Authorization"] = `Bearer ${state.token}`;
    const res = await fetch(url, {...options, headers, signal: state.aborter?.signal });

    if((res.status===403 || res.status===429) && attempt < 6){
      const ra = res.headers.get("retry-after");
      const wait = ra ? Number(ra)*1000 : 60_000;
      log(`Rate limit/Secondary limit. Waiting ${Math.ceil(wait/1000)}s ...`, "warning");
      await sleep(wait);
      return apiFetch(endpoint, options, attempt+1);
    }
    return res;
  }

  async function apiJson(endpoint, options = {}){
    const res = await apiFetch(endpoint, options);
    if(!res.ok){
      const txt = await res.text().catch(()=>"");
      throw new Error(`GitHub API ${res.status}: ${txt || res.statusText}`);
    }
    return res.json();
  }

  
  // --- Stop / Abort ---
  window.stopCurrent = function(){
    if(state.aborter){
      try{ state.aborter.abort(); }catch(_){}
      state.aborter = null;
      log("تم إرسال أمر إيقاف.", "warning");
    } else {
      log("لا توجد عملية نشطة.", "info");
    }
  };
// --- Auth ---
  window.validateToken = async function(){
    const t = el.tokenInput.value.trim();
    if(!t){ log("أدخل التوكن أولاً.", "warning"); return; }
    state.token = t;
    localStorage.setItem(STORAGE_KEY, t);

    log("جاري التحقق من التوكن...", "info");
    try{
      const user = await apiJson("user");
      state.user = user;
      el.userAvatar.src = user.avatar_url || "";
      el.userLogin.textContent = user.login || "";
      el.userName.textContent = user.name || "";
      el.statRepos.textContent = String(user.public_repos ?? "-");
      el.statFollowers.textContent = String(user.followers ?? "-");
      el.statFollowing.textContent = String(user.following ?? "-");
      el.userBox.classList.remove("hidden");
      el.apiHint.textContent = user.login ? `@${user.login}` : "";
      log(`تم التوثيق: ${user.login}`, "success");
      await loadRepos();
      // mobile: close sidebar after auth for usability
      if(window.innerWidth < 768) toggleSidebar(false);
    }catch(e){
      log(e.message, "error");
      clearToken(false);
    }
  };

  window.clearToken = function(reload=true){
    state.token = "";
    state.user = null;
    localStorage.removeItem(STORAGE_KEY);
    el.tokenInput.value = "";
    el.userBox.classList.add("hidden");
    el.apiHint.textContent = "";
    state.repos = [];
    state.selected = null;
    renderRepos([]);
    el.currentRepo.textContent = "—";
    el.branchInfo.textContent = "—";
    if(reload) log("تم حذف التوكن.", "warning");
  };

  // --- Repos ---
  function repoCard(repo){
    const btn = document.createElement("button");
    btn.className = "w-full text-right card rounded-2xl p-3 hover:brightness-110 transition";
    const name = `${repo.owner.login}/${repo.name}`;
    const desc = repo.description || "";
    const meta = `${repo.private ? "Private" : "Public"} • ${repo.default_branch}`;

    const t1 = document.createElement("div");
    t1.className = "font-bold truncate";
    t1.textContent = name;

    const t2 = document.createElement("div");
    t2.className = "text-xs text-[var(--muted)] truncate mt-1";
    t2.textContent = desc;

    const t3 = document.createElement("div");
    t3.className = "text-[10px] text-[var(--muted)] mt-2 mono";
    t3.textContent = meta;

    btn.appendChild(t1); btn.appendChild(t2); btn.appendChild(t3);

    btn.onclick = () => selectRepo(repo);
    return btn;
  }

  function renderRepos(list){
    el.reposList.textContent = "";
    if(!list.length){
      const p = document.createElement("div");
      p.className="text-sm text-[var(--muted)] p-3";
      p.textContent = state.token ? "لا توجد نتائج." : "وثّق التوكن ثم حمّل المستودعات.";
      el.reposList.appendChild(p);
      return;
    }
    for(const r of list) el.reposList.appendChild(repoCard(r));
  }

  window.loadRepos = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    log("جاري جلب المستودعات...", "info");
    const all = [];
    try{
      for(let page=1; page<=20; page++){
        const batch = await apiJson(`user/repos?per_page=100&sort=updated&direction=desc&page=${page}`);
        all.push(...batch);
        if(batch.length < 100) break;
      }
      state.repos = all;
      log(`تم تحميل ${all.length} مستودع.`, "success");
      filterRepos();
    }catch(e){
      log(e.message, "error");
    }
  };

  function filterRepos(){
    const q = (el.repoSearch.value || "").toLowerCase().trim();
    if(!q){ renderRepos(state.repos); return; }
    const filtered = state.repos.filter(r => {
      const n = `${r.owner?.login||""}/${r.name||""}`.toLowerCase();
      const d = (r.description||"").toLowerCase();
      return n.includes(q) || d.includes(q);
    });
    renderRepos(filtered);
  }
  el.repoSearch.addEventListener("input", filterRepos);

  function selectRepo(repo){
    state.selected = { owner: repo.owner.login, repo: repo.name, branch: repo.default_branch, isPrivate: repo.private };
    el.currentRepo.textContent = `${state.selected.owner}/${state.selected.repo}`;
    el.branchInfo.textContent = `Branch: ${state.selected.branch}`;
    log(`تم اختيار: ${state.selected.owner}/${state.selected.repo}@${state.selected.branch}`, "success");
    if(window.innerWidth < 768) toggleSidebar(false);
  }

  // --- Base64 helpers ---
  async function blobToBase64(blob){
    const buf = await blob.arrayBuffer();
    const bytes = new Uint8Array(buf);
    const chunk = 0x8000;
    let bin = "";
    for(let i=0; i<bytes.length; i+=chunk){
      bin += String.fromCharCode(...bytes.subarray(i, i+chunk));
    }
    return btoa(bin);
  }

  function normalizePath(p){
    return p.replace(/^\/+/, "").replace(/\\/g, "/");
  }

  // --- ZIP processing ---
  async function filesFromZip(zipFile, stripRoot){
    const zip = await JSZip.loadAsync(zipFile);
    const entries = [];
    zip.forEach((relativePath, file) => {
      if(!file.dir) entries.push({path: relativePath, file});
    });
    if(!entries.length) return [];

    let rootPrefix = "";
    if(stripRoot){
      // إذا كانت كل الملفات داخل مجلد واحد في الجذر، قم بإزالته
      const first = entries[0].path.split("/")[0];
      const allUnderFirst = entries.every(e => e.path.startsWith(first + "/"));
      if(allUnderFirst) rootPrefix = first + "/";
    }

    const out = [];
    for(const e of entries){
      const p = normalizePath(rootPrefix ? e.path.replace(rootPrefix, "") : e.path);
      const b = await e.file.async("blob");
      out.push({ path: p, blob: b });
    }
    return out;
  }

  // --- Upload (single commit) ---
  async function pushFilesSingleCommit({owner, repo, branch, files, wipe, message, onProgress}){
    // size check
    for(const f of files){
      if(f.blob.size > MAX_FILE_BYTES){
        throw new Error(`File too large (>100MB): ${f.path}`);
      }
    }

    const ref = await apiJson(`repos/${owner}/${repo}/git/ref/heads/${branch}`);
    const parentSha = ref.object.sha;

    const parentCommit = await apiJson(`repos/${owner}/${repo}/git/commits/${parentSha}`);
    const baseTreeSha = parentCommit.tree.sha;

    const treeEntries = [];
    for(let i=0; i<files.length; i++){
      const f = files[i];
      onProgress?.({phase:"blob", done:i, total:files.length, current:f.path});
      const base64 = await blobToBase64(f.blob);
      await sleep(SMALL_DELAY_MS);

      const createdBlob = await apiJson(`repos/${owner}/${repo}/git/blobs`, {
        method: "POST",
        body: JSON.stringify({ content: base64, encoding: "base64" })
      });

      treeEntries.push({ path: normalizePath(f.path), mode:"100644", type:"blob", sha: createdBlob.sha });
      onProgress?.({phase:"blob", done:i+1, total:files.length, current:f.path});
    }

    onProgress?.({phase:"tree"});
    const treeBody = wipe ? { tree: treeEntries } : { base_tree: baseTreeSha, tree: treeEntries };
    const newTree = await apiJson(`repos/${owner}/${repo}/git/trees`, { method:"POST", body: JSON.stringify(treeBody) });

    onProgress?.({phase:"commit"});
    const newCommit = await apiJson(`repos/${owner}/${repo}/git/commits`, {
      method:"POST",
      body: JSON.stringify({ message, tree: newTree.sha, parents: [parentSha] })
    });

    onProgress?.({phase:"ref"});
    await apiJson(`repos/${owner}/${repo}/git/refs/heads/${branch}`, {
      method:"PATCH",
      body: JSON.stringify({ sha: newCommit.sha, force: false })
    });

    return newCommit.sha;
  }

  // --- Gather selected files ---
  async function collectSelectedFiles(){
    const files = [];

    // direct files
    for(const f of (el.fileInput.files || [])){
      files.push({ path: normalizePath(f.name), blob: f });
    }

    // folder files
    for(const f of (el.folderInput.files || [])){
      const p = normalizePath(f.webkitRelativePath || f.name);
      files.push({ path: p, blob: f });
    }

    // zip
    if(el.zipInput.files && el.zipInput.files.length){
      const zipFile = el.zipInput.files[0];
      log(`فك ضغط ZIP: ${zipFile.name}`, "warning");
      const zFiles = await filesFromZip(zipFile, el.stripZipRoot.checked);
      files.push(...zFiles);
    }

    // dedupe by path (keep last)
    const map = new Map();
    for(const f of files){ map.set(f.path, f); }
    const out = [...map.values()];

    // basic sanity
    const bad = out.find(x => !x.path || x.path.endsWith("/"));
    if(bad) throw new Error(`Invalid path: ${bad.path}`);

    return out;
  }

  window.startUpload = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }

    const msg = (el.commitMessage.value || "").trim() || "Update project";
    const wipe = el.wipeBeforeUpload.checked;

    // abort controller per run
    state.aborter = new AbortController();

    try{
      el.btnUpload.disabled = true;
      el.btnStop.disabled = false;
      setProgress({visible:true, text:"تحضير الملفات...", done:0, total:1});
      const files = await collectSelectedFiles();
      if(!files.length){ throw new Error("لم يتم اختيار ملفات/مجلد/ZIP."); }

      log(`عدد الملفات: ${files.length}`, "info");
      if(files.length > 800){
        log("تحذير: عدد ملفات كبير وقد يستهلك Rate Limit. يُفضل تقسيم الرفع.", "warning");
      }

      setProgress({visible:true, text:"رفع Blobs...", done:0, total:files.length});

      const commitSha = await pushFilesSingleCommit({
        owner: state.selected.owner,
        repo: state.selected.repo,
        branch: state.selected.branch,
        files,
        wipe,
        message: msg,
        onProgress: ({phase, done, total, current}) => {
          if(phase==="blob"){
            setProgress({visible:true, text:`رفع: ${current}`, done, total});
          }else if(phase==="tree"){
            setProgress({visible:true, text:"إنشاء Tree...", done:total, total});
          }else if(phase==="commit"){
            setProgress({visible:true, text:"إنشاء Commit...", done:total, total});
          }else if(phase==="ref"){
            setProgress({visible:true, text:"تحديث الفرع...", done:total, total});
          }
        }
      });

      setProgress({visible:true, text:"اكتمل.", done:files.length, total:files.length});
      log(`تم الرفع بنجاح (Commit واحد): ${commitSha}`, "success");
    }catch(e){
      if(e.name === "AbortError"){
        log("تم إيقاف العملية.", "warning");
      }else{
        log(e.message || String(e), "error");
      }
    }finally{
      el.btnUpload.disabled = false;
      el.btnStop.disabled = true;
      // keep progress visible briefly
      await sleep(600);
      setProgress({visible:false});
      state.aborter = null;
    }
  };

  // --- Wipe as single commit (empty tree) ---
  window.wipeRepoCommit = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }

    state.aborter = new AbortController();
    try{
      el.btnStop.disabled = false;
      log("جاري تنفيذ Wipe عبر Commit واحد...", "warning");
      setProgress({visible:true, text:"تحضير...", done:0, total:1});

      const {owner, repo, branch} = state.selected;
      const ref = await apiJson(`repos/${owner}/${repo}/git/ref/heads/${branch}`);
      const parentSha = ref.object.sha;

      const emptyTree = await apiJson(`repos/${owner}/${repo}/git/trees`, {
        method:"POST",
        body: JSON.stringify({ tree: [] })
      });

      const commit = await apiJson(`repos/${owner}/${repo}/git/commits`, {
        method:"POST",
        body: JSON.stringify({ message: "Wipe repository (single commit)", tree: emptyTree.sha, parents: [parentSha] })
      });

      await apiJson(`repos/${owner}/${repo}/git/refs/heads/${branch}`, {
        method:"PATCH",
        body: JSON.stringify({ sha: commit.sha, force: false })
      });

      log(`تم Wipe بنجاح: ${commit.sha}`, "success");
    }catch(e){
      if(e.name === "AbortError"){
        log("تم إيقاف العملية.", "warning");
      }else{
        log(e.message || String(e), "error");
      }
    }finally{
      el.btnStop.disabled = true;
      await sleep(600);
      setProgress({visible:false});
      state.aborter = null;
    }
  };

  // --- ZIP Download ---
  function directZipUrl(){
    if(!state.selected) return null;
    const {owner, repo, branch} = state.selected;
    return `https://github.com/${owner}/${repo}/archive/refs/heads/${branch}.zip`;
  }

  async function downloadZipLocal(){
    el.btnStop.disabled = false;
    const {owner, repo, branch} = state.selected;
    log(`تنزيل ZIP محليًا: ${owner}/${repo}@${branch}`, "warning");
    state.aborter = new AbortController();

    try{
      setProgress({visible:true, text:"جلب ref...", done:0, total:4});
      const ref = await apiJson(`repos/${owner}/${repo}/git/ref/heads/${branch}`);
      setProgress({visible:true, text:"جلب commit...", done:1, total:4});
      const commit = await apiJson(`repos/${owner}/${repo}/git/commits/${ref.object.sha}`);
      const treeSha = commit.tree.sha;

      setProgress({visible:true, text:"جلب tree...", done:2, total:4});
      const tree = await apiJson(`repos/${owner}/${repo}/git/trees/${treeSha}?recursive=1`);
      const blobs = (tree.tree || []).filter(x => x.type === "blob");

      if(blobs.length > 1500){
        log("تحذير: مستودع كبير. تنزيل ZIP محليًا قد يفشل بسبب Rate Limit. استخدم التنزيل المباشر إذا أمكن.", "warning");
      }

      const zip = new JSZip();
      for(let i=0; i<blobs.length; i++){
        const b = blobs[i];
        setProgress({visible:true, text:`تحميل: ${b.path}`, done:i, total:blobs.length});
        const blob = await apiJson(`repos/${owner}/${repo}/git/blobs/${b.sha}`);
        // content base64 with newlines sometimes
        const b64 = (blob.content || "").replace(/\n/g, "");
        const bin = atob(b64);
        const u8 = new Uint8Array(bin.length);
        for(let j=0; j<bin.length; j++) u8[j] = bin.charCodeAt(j);
        zip.file(b.path, u8);
        await sleep(SMALL_DELAY_MS);
      }

      setProgress({visible:true, text:"توليد ZIP...", done:blobs.length, total:blobs.length});
      const zipBlob = await zip.generateAsync({type:"blob"});

      const a = document.createElement("a");
      a.href = URL.createObjectURL(zipBlob);
      a.download = `${repo}_${branch}.zip`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);

      log("تم تنزيل ZIP محليًا.", "success");
    } finally {
      el.btnStop.disabled = true;
      await sleep(600);
      setProgress({visible:false});
      state.aborter = null;
    }
  }

  window.downloadZipDirect = function(){
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }
    const url = directZipUrl();
    if(!url) return;
    log("تنزيل ZIP مباشر...", "info");
    window.open(url, "_blank");
  };

  window.downloadZipLocalUI = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }
    await downloadZipLocal();
  };

    // --- Init ---
  function init(){
    if(el.btnStop) el.btnStop.disabled = true;
    if(state.token){
      el.tokenInput.value = state.token;
      // silent validate (no reload loops)
      validateToken().catch(()=>{});
    } else {
      renderRepos([]);
    }
    log("جاهز. (Commit واحد + Wipe سريع + ZIP)", "success");
  }
  init();

})();
</script>
</body>
</html>
