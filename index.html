<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0d1117" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>GIT UP</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Fira+Code:wght@400;500&display=swap');

    :root{
      --bg:#0d1117;
      --card:#161b22;
      --border:#30363d;
      --text:#c9d1d9;
      --muted:#8b949e;
      --accent:#2f81f7;
      --ok:#3fb950;
      --warn:#d29922;
      --err:#f85149;
    }

    html,body{height:100%;}
    body{background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    code, pre, .mono{font-family:"Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    /* منع تكبير iOS عند التركيز */
    input, button, select, textarea{font-size:16px;}
    .card{background:var(--card);border:1px solid var(--border);}
    .btn{border:1px solid var(--border);background:#21262d;}
    .btn:hover{background:#2d333b;}
    .btn-primary{background:var(--accent);border-color:transparent;color:white;}
    .btn-primary:hover{filter:brightness(1.05);}
    .btn-danger{background:var(--err);border-color:transparent;color:white;}
    .btn-danger:hover{filter:brightness(1.05);}
    .pill{border:1px solid var(--border);background:#0b1220;}
    .divider{border-top:1px solid var(--border);}
    .scrollbar::-webkit-scrollbar{height:10px;width:10px;}
    .scrollbar::-webkit-scrollbar-thumb{background:#2d333b;border-radius:999px;}
  
    /* PWA + Mobile tweaks */
    body{
      padding-bottom: env(safe-area-inset-bottom);
      padding-top: env(safe-area-inset-top);
      overflow-x: hidden;
    }
    @media (max-width: 640px){
      #terminal{font-size:12px;}
      .btn, .btn-primary, .btn-danger{min-height:44px;}
      input, textarea, select{min-height:44px;}
    }

  </style>
</head>

<body>
  <!-- Mobile backdrop -->
  <div id="backdrop" class="fixed inset-0 bg-black/60 z-40 hidden" onclick="toggleSidebar(false)"></div>

  

  <!-- Modal -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black/60 z-[70] hidden" onclick="closeModal()"></div>
  <div id="modal" class="fixed inset-0 z-[80] hidden items-center justify-center p-4">
    <div class="card rounded-2xl w-full max-w-2xl p-4">
      <div class="flex items-center justify-between gap-2">
        <div id="modalTitle" class="font-bold text-lg"></div>
        <button class="btn rounded-xl px-3 py-2" onclick="closeModal()" aria-label="إغلاق">
          <i class="fas fa-xmark"></i>
        </button>
      </div>
      <div id="modalBody" class="mt-4"></div>
    </div>
  </div>

<div class="min-h-screen flex flex-col md:flex-row">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed z-50 inset-y-0 right-0 w-[86vw] max-w-[360px] md:static md:w-[22rem] transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-out will-change-transform">
      <div class="h-full card rounded-none md:rounded-l-2xl md:my-3 md:mr-3 overflow-hidden shadow-2xl flex flex-col">
        <div class="p-4 flex items-center justify-between gap-2 border-b border-[var(--border)]">
          <div class="flex items-center gap-2">
            <i class="fab fa-github text-xl"></i>
            <span class="font-bold">مدير GitHub</span>
          </div>
          <button class="md:hidden btn rounded-xl px-3 py-2" onclick="toggleSidebar(false)" aria-label="إغلاق">
            <i class="fas fa-xmark"></i>
          </button>
        </div>

        <div class="p-4 space-y-3">
          <div class="text-xs text-[var(--muted)] font-bold uppercase tracking-widest">المصادقة</div>

          <label class="text-sm block">رمز الوصول الشخصي</label>
          <input id="tokenInput" type="password" placeholder="ghp_xxx أو github_pat_xxx"
                 class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"/>

          <div class="flex gap-2">
            <button class="btn-primary rounded-2xl px-4 py-3 flex-1 font-bold" onclick="validateToken()">
              <i class="fas fa-shield-halved ml-2"></i>تأكيد التوكن
            </button>
            <button class="btn rounded-2xl px-4 py-3" onclick="clearToken()" title="حذف التوكن">
              <i class="fas fa-trash"></i>
            </button>
          </div>

          <div id="userBox" class="hidden card rounded-2xl p-3">
            <div class="flex items-center gap-3">
              <img id="userAvatar" class="w-10 h-10 rounded-full border border-[var(--border)]" alt="avatar"/>
              <div class="min-w-0">
                <div class="font-bold truncate" id="userLogin"></div>
                <div class="text-xs text-[var(--muted)] truncate" id="userName"></div>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-3 gap-2 text-center text-xs">
              <div class="pill rounded-xl py-2">
                <div class="font-bold" id="statRepos">-</div>
                <div class="text-[var(--muted)]">Repos</div>
              </div>
              <div class="pill rounded-xl py-2">
                <div class="font-bold" id="statFollowers">-</div>
                <div class="text-[var(--muted)]">Followers</div>
              </div>
              <div class="pill rounded-xl py-2">
                <div class="font-bold" id="statFollowing">-</div>
                <div class="text-[var(--muted)]">Following</div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="p-4 space-y-3 flex-1 overflow-hidden">
          <div class="flex items-center justify-between">
            <div class="text-xs text-[var(--muted)] font-bold uppercase tracking-widest">المستودعات</div>
            <button class="btn rounded-xl px-3 py-2 text-sm" onclick="loadRepos()" title="تحديث">
              <i class="fas fa-rotate"></i>
            </button>
          </div>

          <input id="repoSearch" type="text" placeholder="بحث..."
                 class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"/>

          <div id="reposList" class="h-full overflow-auto pr-1 scrollbar space-y-2 pb-2"></div>
        </div>

        <div class="p-4 border-t border-[var(--border)] flex items-center justify-between text-xs text-[var(--muted)]">
          <span class="truncate">LocalStorage</span>
          <span id="apiHint" class="truncate"></span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 md:mr-0">
      <!-- Topbar -->
      <div class="sticky top-0 z-30 backdrop-blur bg-[var(--bg)]/80 border-b border-[var(--border)]">
        <div class="px-4 py-3 flex items-center justify-between gap-2">
          <button class="md:hidden btn rounded-xl px-3 py-2" onclick="toggleSidebar(true)" aria-label="فتح القائمة">
            <i class="fas fa-bars"></i>
          </button>

          <div class="min-w-0 flex-1">
            <div class="text-xs text-[var(--muted)]">المستودع الحالي</div>
            <div class="font-bold truncate" id="currentRepo">—</div>
          </div>

          <div class="hidden sm:flex items-center gap-2">
            
            <button id="btnInstall" class="btn rounded-xl px-3 py-2 hidden" onclick="installPWA()" title="تثبيت التطبيق">
              <i class="fas fa-download ml-2"></i>تثبيت
            </button>
<button class="btn rounded-xl px-3 py-2" onclick="downloadZipDirect()" title="تنزيل ZIP مباشر">
              <i class="fas fa-file-zipper ml-2"></i>ZIP مباشر
            </button>
            <button class="btn rounded-xl px-3 py-2" onclick="downloadZipLocalUI()" title="تنزيل ZIP محلي (للخاص أو عند فشل المباشر)">
              <i class="fas fa-box-archive ml-2"></i>ZIP محلي
            </button>
            <button class="btn-danger rounded-xl px-3 py-2" onclick="wipeRepoCommit()" title="مسح المستودع (Commit)">
              <i class="fas fa-broom ml-2"></i>Wipe
            </button>
          </div>
        </div>

        <!-- Mobile quick actions -->
        <div class="sm:hidden px-4 pb-3 grid grid-cols-2 gap-2">
          <button class="btn rounded-2xl px-4 py-3 flex-1" onclick="downloadZipDirect()">
            <i class="fas fa-file-zipper ml-2"></i>ZIP مباشر
          </button>
          <button class="btn rounded-2xl px-4 py-3 flex-1" onclick="downloadZipLocalUI()">
            <i class="fas fa-box-archive ml-2"></i>ZIP محلي
          </button>
          
          <button id="btnInstallMobile" class="btn rounded-2xl px-4 py-3 flex-1 hidden" onclick="installPWA()">
            <i class="fas fa-download ml-2"></i>تثبيت
          </button>
<button class="btn-danger rounded-2xl px-4 py-3 flex-1 col-span-2" onclick="wipeRepoCommit()">
            <i class="fas fa-broom ml-2"></i>Wipe
          </button>
        </div>

        <div id="updateBanner" class="hidden px-4 py-2 bg-[#0b1220] border-t border-[var(--border)] text-sm flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="font-bold">يتوفر تحديث للتطبيق</div>
            <div class="text-xs text-[var(--muted)]">اضغط "تحديث" لتفعيل النسخة الجديدة.</div>
          </div>
          <button class="btn rounded-xl px-3 py-2 text-sm" onclick="applyUpdate()">
            <i class="fas fa-rotate ml-2"></i>تحديث
          </button>
        </div>

      </div>

      <div class="p-4 space-y-4">
        <!-- Upload Card -->
        <section class="card rounded-2xl p-4">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="font-bold text-lg">رفع مشروع</div>
              <div class="text-sm text-[var(--muted)]">Commit واحد + مسارات مجلدات + مؤشرات تقدم</div>
            </div>
            <div class="text-xs text-[var(--muted)] mono" id="branchInfo">—</div>
          </div>

          
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-[1fr_auto_auto] gap-2">
            <select id="branchSelect"
                    class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"
                    disabled></select>
            <button id="btnRefreshBranches" class="btn rounded-2xl px-4 py-3 font-bold" onclick="refreshBranches()" disabled>
              <i class="fas fa-code-branch ml-2"></i>تحديث
            </button>
            <button id="btnNewBranch" class="btn rounded-2xl px-4 py-3 font-bold" onclick="openNewBranchModal()" disabled>
              <i class="fas fa-plus ml-2"></i>فرع جديد
            </button>
          </div>
<div class="mt-4 grid md:grid-cols-2 gap-4">
            <div class="space-y-3">
              <label class="text-sm font-bold">اختيار ملفات</label>
              <input id="fileInput" type="file" multiple
                     class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white"/>

              <label class="text-sm font-bold">اختيار مجلد (يدعم المسارات)</label>
              <input id="folderInput" type="file" webkitdirectory directory multiple
                     class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white"/>

              <label class="text-sm font-bold">رفع ZIP</label>
              <input id="zipInput" type="file" accept=".zip"
                     class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white"/>

              <div class="flex items-center gap-2">
                <input id="stripZipRoot" type="checkbox" class="w-4 h-4">
                <label for="stripZipRoot" class="text-sm">إزالة مجلد الجذر من ZIP (إن وُجد)</label>
              </div>
            </div>

            <div class="space-y-3">
              <label class="text-sm font-bold">رسالة الـ Commit</label>
              <input id="commitMessage" type="text" placeholder="مثال: تحديث المشروع"
                     class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"/>

              <div class="flex items-center gap-2">
                <input id="wipeBeforeUpload" type="checkbox" class="w-4 h-4">
                <label for="wipeBeforeUpload" class="text-sm font-bold text-[var(--warn)]">مسح قبل الرفع (يستبدل كل الملفات)</label>
              </div>

              
              <div class="divider my-2"></div>
              <div class="text-xs text-[var(--muted)] font-bold uppercase tracking-widest">خيارات متقدمة</div>

              <label class="text-sm font-bold">تجاهل مسارات (سطر لكل نمط)</label>
              <textarea id="ignorePatterns" rows="4" placeholder="مثال: node_modules/&#10;.git/&#10;dist/&#10;*.log"
                        class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"></textarea>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-sm font-bold block mb-1">التوازي</label>
                  <select id="uploadConcurrency"
                          class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]">
                    <option value="1">1</option>
                    <option value="2" selected>2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                  </select>
                </div>
                <div class="flex flex-col justify-end">
                  <button class="btn rounded-2xl px-4 py-3 w-full font-bold" onclick="previewSelectedFiles()">
                    <i class="fas fa-list-check ml-2"></i>معاينة
                  </button>
                </div>
              </div>
<div class="grid grid-cols-2 gap-2">
              <button id="btnUpload" class="btn-primary rounded-2xl px-4 py-4 w-full font-bold text-lg disabled:opacity-60 disabled:cursor-not-allowed" onclick="startUpload()">
                <i class="fas fa-cloud-arrow-up ml-2"></i>بدء الرفع
              </button>
              <button id="btnStop" class="btn rounded-2xl px-4 py-4 w-full font-bold text-lg" onclick="stopCurrent()">
                <i class="fas fa-stop ml-2"></i>إيقاف
              </button>
            </div>

              <div id="progressBox" class="hidden">
                <div class="flex justify-between text-xs text-[var(--muted)]">
                  <span id="progressText">—</span>
                  <span class="mono" id="progressCount">0/0</span>
                </div>
                <div class="mt-2 w-full bg-[#0b1220] border border-[var(--border)] rounded-full overflow-hidden">
                  <div id="progressBar" class="h-3 bg-[var(--accent)] w-0 transition-all"></div>
                </div>
              </div>

              <div class="text-xs text-[var(--muted)]">
                ملاحظة: ملفات أكبر من <span class="mono">100MB</span> سيتم رفضها لتجنب مشاكل المتصفح.
              </div>
            </div>
          </div>
        </section>

        <section id="filesSection" class="card rounded-2xl p-4 hidden">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="font-bold">ملفات المستودع</div>
              <div class="text-sm text-[var(--muted)] mono" id="filesPath">—</div>
            </div>
            <button id="btnFilesRefresh" class="btn rounded-xl px-3 py-2" onclick="refreshFiles()" disabled>
              <i class="fas fa-rotate ml-2"></i>تحديث
            </button>
          </div>

          <div id="filesBreadcrumb" class="mt-3 flex flex-wrap gap-2"></div>
          <div id="filesList" class="mt-3 space-y-2"></div>
          <div id="filesEmpty" class="mt-3 text-sm text-[var(--muted)] hidden">لا توجد عناصر.</div>
        </section>

        <!-- Terminal -->
        <section class="card rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold">السجل</div>
            <button class="btn rounded-xl px-3 py-2 text-sm" onclick="clearLog()"><i class="fas fa-eraser ml-2"></i>مسح</button>
          </div>
          <div id="terminal" class="mt-3 h-44 md:h-56 overflow-auto scrollbar bg-[#0b1220] border border-[var(--border)] rounded-2xl p-3 mono text-sm leading-relaxed"></div>
        </section>
      </div>
    </main>
  </div>

<script>
(() => {
  function clampInt(v, min, max){
    v = Number.isFinite(v) ? Math.trunc(v) : min;
    return Math.max(min, Math.min(max, v));
  }

  function formatBytes(bytes){
    const units = ["B","KB","MB","GB"];
    let b = Number(bytes) || 0;
    let u = 0;
    while(b >= 1024 && u < units.length-1){ b /= 1024; u++; }
    return `${b.toFixed(u===0?0:1)} ${units[u]}`;
  }

  // --- Modal ---
  window.openModal = function(title, bodyHtml){
    if(!el.modal || !el.modalBackdrop) return;
    el.modalTitle.textContent = title || "";
    el.modalBody.innerHTML = bodyHtml || "";
    el.modalBackdrop.classList.remove("hidden");
    el.modal.classList.remove("hidden");
    el.modal.classList.add("flex");
    document.body.style.overflow = "hidden";
  };

  window.closeModal = function(){
    if(!el.modal || !el.modalBackdrop) return;
    el.modalBackdrop.classList.add("hidden");
    el.modal.classList.add("hidden");
    el.modal.classList.remove("flex");
    el.modalTitle.textContent = "";
    el.modalBody.innerHTML = "";
    document.body.style.overflow = "";
  };

  // --- Ignore patterns (glob) ---
  function compileIgnore(patternsText){
    const lines = (patternsText || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean).filter(s => !s.startsWith("#"));
    const regs = [];
    for(let p of lines){
      p = normalizePath(p);
      if(!p) continue;
      if(p.endsWith("/")) p = p + "**";
      const anchored = p.startsWith("/");
      if(anchored) p = p.slice(1);

      let rx = "";
      let i = 0;
      while(i < p.length){
        const ch = p[i];
        if(ch === "*"){
          if(p[i+1] === "*"){
            rx += ".*";
            i += 2;
          } else {
            rx += "[^/]*";
            i += 1;
          }
          continue;
        }
        if(ch === "?"){
          rx += "[^/]";
          i += 1;
          continue;
        }
        rx += ch.replace(/[\\^$+?.()|\[\]{}]/g, "\\$&");
        i += 1;
      }

      const prefix = anchored ? "^" : "(^|.*/)";
      regs.push(new RegExp(prefix + rx + "$", "i"));
    }
    return regs;
  }

  function isIgnoredPath(path, regs){
    if(!regs || !regs.length) return false;
    const p = normalizePath(path);
    for(const r of regs){
      if(r.test(p)) return true;
    }
    return false;
  }

  // --- Concurrency helper ---
  async function mapWithConcurrency(items, limit, worker){
    const out = [];
    let idx = 0;
    const runners = new Array(Math.min(limit, items.length)).fill(0).map(async () => {
      while(true){
        const i = idx++;
        if(i >= items.length) return;
        out[i] = await worker(items[i], i);
      }
    });
    await Promise.all(runners);
    return out;
  }

const STORAGE_KEY = "gh_token_session";
  const MAX_FILE_BYTES = 100 * 1024 * 1024;
  const SMALL_DELAY_MS = 200; // لتخفيف secondary rate limits

  const state = {
    token: localStorage.getItem(STORAGE_KEY) || "",
    user: null,
    repos: [],
    selected: null, // {owner, repo, branch, isPrivate}
    branches: [],
    repoPath: "",
    aborter: null,
    deferredInstall: null,
    swReg: null,
  };

  const el = {
    sidebar: document.getElementById("sidebar"),
    backdrop: document.getElementById("backdrop"),
    tokenInput: document.getElementById("tokenInput"),
    userBox: document.getElementById("userBox"),
    userAvatar: document.getElementById("userAvatar"),
    userLogin: document.getElementById("userLogin"),
    userName: document.getElementById("userName"),
    statRepos: document.getElementById("statRepos"),
    statFollowers: document.getElementById("statFollowers"),
    statFollowing: document.getElementById("statFollowing"),
    repoSearch: document.getElementById("repoSearch"),
    reposList: document.getElementById("reposList"),
    currentRepo: document.getElementById("currentRepo"),
    branchInfo: document.getElementById("branchInfo"),
    branchSelect: document.getElementById("branchSelect"),
    btnRefreshBranches: document.getElementById("btnRefreshBranches"),
    btnNewBranch: document.getElementById("btnNewBranch"),
    ignorePatterns: document.getElementById("ignorePatterns"),
    uploadConcurrency: document.getElementById("uploadConcurrency"),

    modalBackdrop: document.getElementById("modalBackdrop"),
    modal: document.getElementById("modal"),
    modalTitle: document.getElementById("modalTitle"),
    modalBody: document.getElementById("modalBody"),

    btnInstall: document.getElementById("btnInstall"),
    btnInstallMobile: document.getElementById("btnInstallMobile"),
    updateBanner: document.getElementById("updateBanner"),
    apiHint: document.getElementById("apiHint"),

    fileInput: document.getElementById("fileInput"),
    folderInput: document.getElementById("folderInput"),
    zipInput: document.getElementById("zipInput"),
    stripZipRoot: document.getElementById("stripZipRoot"),
    commitMessage: document.getElementById("commitMessage"),
    wipeBeforeUpload: document.getElementById("wipeBeforeUpload"),
    btnUpload: document.getElementById("btnUpload"),
    btnStop: document.getElementById("btnStop"),

    progressBox: document.getElementById("progressBox"),
    progressText: document.getElementById("progressText"),
    progressCount: document.getElementById("progressCount"),
    progressBar: document.getElementById("progressBar"),

    filesSection: document.getElementById("filesSection"),
    filesPath: document.getElementById("filesPath"),
    filesBreadcrumb: document.getElementById("filesBreadcrumb"),
    filesList: document.getElementById("filesList"),
    filesEmpty: document.getElementById("filesEmpty"),
    btnFilesRefresh: document.getElementById("btnFilesRefresh"),

    terminal: document.getElementById("terminal"),
  };

  // --- UI helpers (safe text only) ---
  const nowTime = () => new Date().toLocaleTimeString([], {hour12:false});
  function log(msg, level="info"){
    const row = document.createElement("div");
    const time = document.createElement("span");
    time.className = "text-[var(--muted)]";
    time.textContent = `[${nowTime()}] `;

    const text = document.createElement("span");
    text.textContent = msg;

    if(level==="success") text.className="text-[var(--ok)]";
    if(level==="warning") text.className="text-[var(--warn)]";
    if(level==="error") text.className="text-[var(--err)]";

    row.appendChild(time);
    row.appendChild(text);
    el.terminal.appendChild(row);
    el.terminal.scrollTop = el.terminal.scrollHeight;
  }

  window.clearLog = function(){ el.terminal.textContent = ""; };

  function setProgress({visible, text, done, total}){
    if(visible){
      el.progressBox.classList.remove("hidden");
      el.progressText.textContent = text || "";
      el.progressCount.textContent = `${done||0}/${total||0}`;
      const pct = total ? Math.round((done/total)*100) : 0;
      el.progressBar.style.width = `${Math.min(100, Math.max(0,pct))}%`;
    } else {
      el.progressBox.classList.add("hidden");
      el.progressBar.style.width = "0%";
      el.progressText.textContent = "—";
      el.progressCount.textContent = "0/0";
    }
  }

  // --- Sidebar ---
  window.toggleSidebar = function(open){
    const shouldOpen = (open === undefined) ? el.sidebar.classList.contains("translate-x-full") : open;
    if(shouldOpen){
      el.sidebar.classList.remove("translate-x-full");
      el.backdrop.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    } else {
      el.sidebar.classList.add("translate-x-full");
      el.backdrop.classList.add("hidden");
      document.body.style.overflow = "";
    }
  };

  // --- API wrapper with basic rate-limit handling ---
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  async function apiFetch(endpoint, options = {}, attempt=0){
    const url = `https://api.github.com/${endpoint}`;
    const headers = {
      "Accept": "application/vnd.github+json",
      "X-GitHub-Api-Version": "2022-11-28",
      ...(options.headers || {})
    };
    const hasCT = Object.keys(headers).some(k => k.toLowerCase() === "content-type");
    if(options.body != null && typeof options.body === "string" && !hasCT){
      headers["Content-Type"] = "application/json";
    }
    if(state.token) headers["Authorization"] = `Bearer ${state.token}`;

    const res = await fetch(url, {...options, headers, signal: state.aborter?.signal });

    if((res.status===403 || res.status===429) && attempt < 6){
      const retryAfter = res.headers.get("retry-after");
      const remaining = res.headers.get("x-ratelimit-remaining");
      const reset = res.headers.get("x-ratelimit-reset");
      const bodyTxt = await res.clone().text().catch(()=> "");

      const isSecondary = /secondary rate limit/i.test(bodyTxt);
      const isPrimaryExceeded = /rate limit exceeded/i.test(bodyTxt) || remaining === "0";

      const shouldRetry = res.status === 429 || isSecondary || isPrimaryExceeded;
      if(shouldRetry){
        let waitMs = 0;
        if(retryAfter){
          waitMs = Math.max(1000, Number(retryAfter) * 1000);
        } else if(isPrimaryExceeded && reset){
          const resetMs = Number(reset) * 1000;
          waitMs = Math.max(1000, resetMs - Date.now() + 1500);
        } else {
          const base = 1500 * Math.pow(2, attempt);
          waitMs = Math.min(120000, base + Math.floor(Math.random() * 1000));
        }

        log(`تم الوصول لحدود GitHub API. انتظار ${Math.ceil(waitMs/1000)} ث...`, "warning");
        await sleep(waitMs);
        return apiFetch(endpoint, options, attempt+1);
      }
    }
    return res;
  }

  async function apiJson(endpoint, options = {}){
    const res = await apiFetch(endpoint, options);
    if(!res.ok){
      const txt = await res.text().catch(()=>"");
      throw new Error(`GitHub API ${res.status}: ${txt || res.statusText}`);
    }
    return res.json();
  }

  
  // --- Stop / Abort ---
  window.stopCurrent = function(){
    if(state.aborter){
      try{ state.aborter.abort(); }catch(_){}
      state.aborter = null;
      log("تم إرسال أمر إيقاف.", "warning");
    } else {
      log("لا توجد عملية نشطة.", "info");
    }
  };
// --- Auth ---
  window.validateToken = async function(){
    const t = el.tokenInput.value.trim();
    if(!t){ log("أدخل التوكن أولاً.", "warning"); return; }
    state.token = t;
    localStorage.setItem(STORAGE_KEY, t);

    log("جاري التحقق من التوكن...", "info");
    try{
      const user = await apiJson("user");
      state.user = user;
      el.userAvatar.src = user.avatar_url || "";
      el.userLogin.textContent = user.login || "";
      el.userName.textContent = user.name || "";
      el.statRepos.textContent = String(user.public_repos ?? "-");
      el.statFollowers.textContent = String(user.followers ?? "-");
      el.statFollowing.textContent = String(user.following ?? "-");
      el.userBox.classList.remove("hidden");
      el.apiHint.textContent = user.login ? `@${user.login}` : "";
      log(`تم التوثيق: ${user.login}`, "success");
      await loadRepos();
      // mobile: close sidebar after auth for usability
      if(window.innerWidth < 768) toggleSidebar(false);
    }catch(e){
      log(e.message, "error");
      clearToken(false);
    }
  };

  window.clearToken = function(reload=true){
    state.token = "";
    state.user = null;
    localStorage.removeItem(STORAGE_KEY);
    el.tokenInput.value = "";
    el.userBox.classList.add("hidden");
    el.apiHint.textContent = "";
    state.repos = [];
    state.selected = null;
    state.branches = [];
    state.repoPath = "";
    if(el.filesSection) el.filesSection.classList.add("hidden");
    if(el.filesPath) el.filesPath.textContent = "—";
    if(el.filesBreadcrumb) el.filesBreadcrumb.textContent = "";
    if(el.filesList) el.filesList.textContent = "";
    if(el.filesEmpty) el.filesEmpty.classList.add("hidden");
    if(el.btnFilesRefresh) el.btnFilesRefresh.disabled = true;
    renderRepos([]);
    el.currentRepo.textContent = "—";
    el.branchInfo.textContent = "—";
    if(el.branchSelect){ el.branchSelect.innerHTML=""; el.branchSelect.disabled = true; }
    if(el.btnRefreshBranches) el.btnRefreshBranches.disabled = true;
    if(el.btnNewBranch) el.btnNewBranch.disabled = true;
    if(reload) log("تم حذف التوكن.", "warning");
  };

  // --- Repos ---
  function repoCard(repo){
    const btn = document.createElement("button");
    const isActive = !!(state.selected && state.selected.owner === repo.owner.login && state.selected.repo === repo.name);
    btn.className = "w-full text-right card rounded-2xl p-3 transition outline-none focus:ring-2 focus:ring-[var(--accent)] " + (isActive ? "ring-2 ring-[var(--accent)] brightness-110" : "hover:brightness-110");
    const name = `${repo.owner.login}/${repo.name}`;
    const desc = repo.description || "";
    const meta = `${repo.private ? "خاص" : "عام"} • ${repo.default_branch}`;

    const t1 = document.createElement("div");
    t1.className = "font-bold truncate";
    t1.textContent = name;

    const t2 = document.createElement("div");
    t2.className = "text-xs text-[var(--muted)] truncate mt-1";
    t2.textContent = desc;

    const t3 = document.createElement("div");
    t3.className = "text-[10px] text-[var(--muted)] mt-2 mono";
    t3.textContent = meta;

    btn.appendChild(t1); btn.appendChild(t2); btn.appendChild(t3);

    btn.onclick = () => selectRepo(repo);
    return btn;
  }

  function renderRepos(list){
    el.reposList.textContent = "";
    if(!list.length){
      const p = document.createElement("div");
      p.className="text-sm text-[var(--muted)] p-3";
      p.textContent = state.token ? "لا توجد نتائج." : "وثّق التوكن ثم حمّل المستودعات.";
      el.reposList.appendChild(p);
      return;
    }
    for(const r of list) el.reposList.appendChild(repoCard(r));
  }

  window.loadRepos = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    log("جاري جلب المستودعات...", "info");
    const all = [];
    try{
      for(let page=1; page<=20; page++){
        const batch = await apiJson(`user/repos?per_page=100&sort=updated&direction=desc&page=${page}`);
        all.push(...batch);
        if(batch.length < 100) break;
      }
      state.repos = all;
      log(`تم تحميل ${all.length} مستودع.`, "success");
      filterRepos();
    }catch(e){
      log(e.message, "error");
    }
  };

  function filterRepos(){
    const q = (el.repoSearch.value || "").toLowerCase().trim();
    if(!q){ renderRepos(state.repos); return; }
    const filtered = state.repos.filter(r => {
      const n = `${r.owner?.login||""}/${r.name||""}`.toLowerCase();
      const d = (r.description||"").toLowerCase();
      return n.includes(q) || d.includes(q);
    });
    renderRepos(filtered);
  }
  el.repoSearch.addEventListener("input", filterRepos);

  function selectRepo(repo){
    state.selected = { owner: repo.owner.login, repo: repo.name, branch: repo.default_branch, isPrivate: repo.private };
    state.branches = [];
    state.repoPath = "";
    el.currentRepo.textContent = `${state.selected.owner}/${state.selected.repo}`;
    setSelectedBranch(state.selected.branch, false);
    if(el.filesSection) el.filesSection.classList.remove("hidden");
    if(el.btnFilesRefresh) el.btnFilesRefresh.disabled = false;
    if(el.filesPath) el.filesPath.textContent = "/";
    refreshFiles().catch(()=>{});
    filterRepos();
    log(`تم اختيار: ${state.selected.owner}/${state.selected.repo}`, "success");
    refreshBranches().catch(()=>{});
    if(window.innerWidth < 768) toggleSidebar(false);
  }

  function renderBranches(){
    const sel = el.branchSelect;
    if(!sel) return;
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = state.selected ? "اختر فرعاً" : "اختر مستودعاً أولاً";
    sel.appendChild(opt0);

    for(const name of state.branches){
      const o = document.createElement("option");
      o.value = name;
      o.textContent = name;
      sel.appendChild(o);
    }
  }

  function setSelectedBranch(name, logIt=true){
    if(!state.selected) return;
    const b = (name || "").trim() || state.selected.branch;
    state.selected.branch = b;
    if(el.branchInfo) el.branchInfo.textContent = `الفرع: ${b}`;
    if(el.branchSelect){
      el.branchSelect.disabled = false;
      el.branchSelect.value = b;
    }
    if(logIt) log(`تم تعيين الفرع: ${b}`, "info");
  }

  window.refreshBranches = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }

    if(el.branchSelect) el.branchSelect.disabled = true;
    if(el.btnRefreshBranches) el.btnRefreshBranches.disabled = true;
    if(el.btnNewBranch) el.btnNewBranch.disabled = true;

    const {owner, repo} = state.selected;
    log("جاري جلب الفروع...", "info");

    const all = [];
    for(let page=1; page<=5; page++){
      const batch = await apiJson(`repos/${owner}/${repo}/branches?per_page=100&page=${page}`);
      all.push(...batch);
      if(batch.length < 100) break;
    }

    const names = [...new Set(all.map(b => b.name))].sort((a,b) => a.localeCompare(b));
    state.branches = names;

    renderBranches();

    const current = state.selected.branch;
    if(current && !state.branches.includes(current)){
      state.branches.unshift(current);
      renderBranches();
    }

    if(el.branchSelect) el.branchSelect.disabled = false;
    if(el.btnRefreshBranches) el.btnRefreshBranches.disabled = false;
    if(el.btnNewBranch) el.btnNewBranch.disabled = false;

    setSelectedBranch(current, false);
    log(`تم تحميل ${state.branches.length} فرع.`, "success");
  };

  if(el.branchSelect){
    el.branchSelect.addEventListener("change", () => {
      const v = el.branchSelect.value;
      if(v){ setSelectedBranch(v, true); refreshFiles().catch(()=>{}); }
    });
  }

  function encodePath(p){
    return (p || "").split("/").filter(Boolean).map(encodeURIComponent).join("/");
  }

  function setFilesPath(p){
    state.repoPath = p || "";
    if(el.filesPath) el.filesPath.textContent = "/" + state.repoPath;
    renderFilesBreadcrumb();
  }

  function renderFilesBreadcrumb(){
    if(!el.filesBreadcrumb) return;
    el.filesBreadcrumb.textContent = "";
    const parts = state.repoPath ? state.repoPath.split("/").filter(Boolean) : [];
    const makeBtn = (label, path) => {
      const b = document.createElement("button");
      b.className = "btn rounded-xl px-3 py-1 text-sm";
      b.textContent = label;
      b.onclick = () => { setFilesPath(path); refreshFiles().catch(()=>{}); };
      return b;
    };
    el.filesBreadcrumb.appendChild(makeBtn("الجذر", ""));
    let acc = "";
    for(const part of parts){
      acc = acc ? `${acc}/${part}` : part;
      el.filesBreadcrumb.appendChild(makeBtn(part, acc));
    }
  }

  function renderFilesList(items){
    if(!el.filesList) return;
    el.filesList.textContent = "";
    const sorted = (items || []).slice().sort((a,b) => {
      const ta = a.type === "dir" ? 0 : 1;
      const tb = b.type === "dir" ? 0 : 1;
      if(ta !== tb) return ta - tb;
      return (a.name || "").localeCompare(b.name || "", "ar");
    });
    if(el.filesEmpty){
      if(sorted.length) el.filesEmpty.classList.add("hidden");
      else el.filesEmpty.classList.remove("hidden");
    }

    for(const item of sorted){
      const row = document.createElement("div");
      row.className = "w-full text-right card rounded-2xl px-3 py-2 flex items-center justify-between gap-3";
      if(item.type === "dir"){
        row.classList.add("cursor-pointer","hover:brightness-110","transition");
        row.onclick = () => { setFilesPath(item.path); refreshFiles().catch(()=>{}); };
      }

      const left = document.createElement("div");
      left.className = "min-w-0 flex items-center gap-3";
      const icon = document.createElement("i");
      icon.className = item.type === "dir" ? "fas fa-folder" : "fas fa-file";
      const name = document.createElement("div");
      name.className = "truncate";
      name.textContent = item.name || "";
      left.appendChild(icon);
      left.appendChild(name);

      const right = document.createElement("div");
      right.className = "shrink-0 flex items-center gap-2";
      if(item.type !== "dir"){
        const size = document.createElement("div");
        size.className = "text-xs text-[var(--muted)] mono";
        size.textContent = formatBytes(item.size || 0);
        const dl = document.createElement("button");
        dl.className = "btn rounded-xl px-3 py-2 text-xs";
        dl.innerHTML = '<i class="fas fa-download ml-2"></i>تنزيل';
        dl.onclick = (e) => { e.stopPropagation(); downloadSingleFile(item.path, item.name).catch(()=>{}); };
        right.appendChild(size);
        right.appendChild(dl);
      }else{
        const hint = document.createElement("div");
        hint.className = "text-xs text-[var(--muted)]";
        hint.innerHTML = '<i class="fas fa-angle-left ml-1"></i>فتح';
        right.appendChild(hint);
      }

      row.appendChild(left);
      row.appendChild(right);
      el.filesList.appendChild(row);
    }
  }

  async function downloadSingleFile(path, filename){
    if(!state.selected) return;
    const owner = state.selected.owner;
    const repo = state.selected.repo;
    const ref = state.selected.branch;
    const ep = `repos/${owner}/${repo}/contents/${encodePath(path)}?ref=${encodeURIComponent(ref)}`;
    const res = await apiFetch(ep, { headers: { "Accept": "application/vnd.github.raw" } });
    if(!res.ok){
      const txt = await res.text().catch(()=>"");
      throw new Error(`فشل تنزيل الملف: ${res.status} ${txt || res.statusText}`);
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename || (path.split("/").pop() || "file");
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  }

  window.refreshFiles = async function(){
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }
    const owner = state.selected.owner;
    const repo = state.selected.repo;
    const ref = state.selected.branch;
    const p = state.repoPath || "";
    if(el.filesPath) el.filesPath.textContent = "/" + p;
    if(el.filesEmpty) el.filesEmpty.classList.add("hidden");
    if(el.filesList) el.filesList.textContent = "";
    const ep = p ? `repos/${owner}/${repo}/contents/${encodePath(p)}?ref=${encodeURIComponent(ref)}` : `repos/${owner}/${repo}/contents?ref=${encodeURIComponent(ref)}`;
    try{
      const items = await apiJson(ep);
      renderFilesBreadcrumb();
      renderFilesList(Array.isArray(items) ? items : []);
    }catch(e){
      renderFilesBreadcrumb();
      if(el.filesList){
        const msg = document.createElement("div");
        msg.className = "text-sm text-[var(--muted)] p-3";
        msg.textContent = e.message;
        el.filesList.appendChild(msg);
      }
    }
  };

  window.openNewBranchModal = function(){
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }
    const base = state.selected.branch;
    openModal("إنشاء فرع جديد", `
      <div class="space-y-3">
        <div class="text-sm text-[var(--muted)]">الفرع الأساسي: <span class="mono">${base}</span></div>

        <label class="text-sm font-bold block">اسم الفرع الجديد</label>
        <input id="newBranchName" type="text" placeholder="مثال: feature/mobile"
               class="w-full rounded-2xl px-4 py-3 bg-[#0b1220] border border-[var(--border)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"/>

        <div class="grid grid-cols-2 gap-2">
          <button class="btn-primary rounded-2xl px-4 py-3 font-bold" onclick="createBranchFromUI()">
            <i class="fas fa-check ml-2"></i>إنشاء
          </button>
          <button class="btn rounded-2xl px-4 py-3 font-bold" onclick="closeModal()">
            <i class="fas fa-xmark ml-2"></i>إلغاء
          </button>
        </div>
      </div>
    `);
    setTimeout(() => {
      const inp = document.getElementById("newBranchName");
      if(inp) inp.focus();
    }, 50);
  };

  window.createBranchFromUI = async function(){
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }
    const inp = document.getElementById("newBranchName");
    const name = (inp?.value || "").trim();
    if(!name){ log("أدخل اسم الفرع.", "warning"); return; }
    if(/\s/.test(name) || name.startsWith("/") || name.endsWith("/") || name.includes("..")){
      log("اسم الفرع غير صالح.", "warning");
      return;
    }

    const {owner, repo, branch} = state.selected;

    try{
      log(`جاري إنشاء فرع: ${name}`, "info");
      const baseRef = await apiJson(`repos/${owner}/${repo}/git/ref/heads/${branch}`);
      const sha = baseRef.object.sha;

      await apiJson(`repos/${owner}/${repo}/git/refs`, {
        method:"POST",
        body: JSON.stringify({ ref: `refs/heads/${name}`, sha })
      });

      closeModal();
      await refreshBranches();
      setSelectedBranch(name, true);
      log("تم إنشاء الفرع بنجاح.", "success");
    }catch(e){
      log(e.message || String(e), "error");
    }
  };



  // --- Base64 helpers ---
  async function blobToBase64(blob){
    const buf = await blob.arrayBuffer();
    const bytes = new Uint8Array(buf);
    const chunk = 0x8000;
    let bin = "";
    for(let i=0; i<bytes.length; i+=chunk){
      bin += String.fromCharCode(...bytes.subarray(i, i+chunk));
    }
    return btoa(bin);
  }

  function normalizePath(p){
    return p.replace(/^\/+/, "").replace(/\\/g, "/");
  }

  // --- ZIP processing ---
  async function filesFromZip(zipFile, stripRoot){
    const zip = await JSZip.loadAsync(zipFile);
    const entries = [];
    zip.forEach((relativePath, file) => {
      if(!file.dir) entries.push({path: relativePath, file});
    });
    if(!entries.length) return [];

    let rootPrefix = "";
    if(stripRoot){
      // إذا كانت كل الملفات داخل مجلد واحد في الجذر، قم بإزالته
      const first = entries[0].path.split("/")[0];
      const allUnderFirst = entries.every(e => e.path.startsWith(first + "/"));
      if(allUnderFirst) rootPrefix = first + "/";
    }

    const out = [];
    for(const e of entries){
      const p = normalizePath(rootPrefix ? e.path.replace(rootPrefix, "") : e.path);
      const b = await e.file.async("blob");
      out.push({ path: p, blob: b });
    }
    return out;
  }

  // --- Upload (single commit) ---
  async function pushFilesSingleCommit({owner, repo, branch, files, wipe, message, onProgress}){
    // size check
    for(const f of files){
      if(f.blob.size > MAX_FILE_BYTES){
        throw new Error(`الملف أكبر من 100MB: ${f.path}`);
      }
    }

    const ref = await apiJson(`repos/${owner}/${repo}/git/ref/heads/${branch}`);
    const parentSha = ref.object.sha;

    const parentCommit = await apiJson(`repos/${owner}/${repo}/git/commits/${parentSha}`);
    const baseTreeSha = parentCommit.tree.sha;

    const treeEntries = [];
    const concurrency = clampInt(Number(el.uploadConcurrency ? el.uploadConcurrency.value : 2), 1, 4);
    let doneBlobs = 0;

    await mapWithConcurrency(files, concurrency, async (f) => {
      onProgress?.({phase:"blob", done:doneBlobs, total:files.length, current:f.path});
      const base64 = await blobToBase64(f.blob);
      await sleep(SMALL_DELAY_MS);

      const createdBlob = await apiJson(`repos/${owner}/${repo}/git/blobs`, {
        method: "POST",
        body: JSON.stringify({ content: base64, encoding: "base64" })
      });

      treeEntries.push({ path: normalizePath(f.path), mode:"100644", type:"blob", sha: createdBlob.sha });
      doneBlobs += 1;
      onProgress?.({phase:"blob", done:doneBlobs, total:files.length, current:f.path});
    });

    onProgress?.({phase:"tree"});
    const treeBody = wipe ? { tree: treeEntries } : { base_tree: baseTreeSha, tree: treeEntries };
    const newTree = await apiJson(`repos/${owner}/${repo}/git/trees`, { method:"POST", body: JSON.stringify(treeBody) });

    onProgress?.({phase:"commit"});
    const newCommit = await apiJson(`repos/${owner}/${repo}/git/commits`, {
      method:"POST",
      body: JSON.stringify({ message, tree: newTree.sha, parents: [parentSha] })
    });

    onProgress?.({phase:"ref"});
    await apiJson(`repos/${owner}/${repo}/git/refs/heads/${branch}`, {
      method:"PATCH",
      body: JSON.stringify({ sha: newCommit.sha, force: false })
    });

    return newCommit.sha;
  }

  // --- Gather selected files ---
  async function collectSelectedFiles(){
    const files = [];

    // direct files
    for(const f of (el.fileInput.files || [])){
      files.push({ path: normalizePath(f.name), blob: f });
    }

    // folder files
    for(const f of (el.folderInput.files || [])){
      const p = normalizePath(f.webkitRelativePath || f.name);
      files.push({ path: p, blob: f });
    }

    // zip
    if(el.zipInput.files && el.zipInput.files.length){
      const zipFile = el.zipInput.files[0];
      log(`فك ضغط ZIP: ${zipFile.name}`, "warning");
      const zFiles = await filesFromZip(zipFile, el.stripZipRoot.checked);
      files.push(...zFiles);
    }

    // dedupe by path (keep last)
    const map = new Map();
    for(const f of files){ map.set(f.path, f); }
    const out = [...map.values()];

    // basic sanity
    const bad = out.find(x => !x.path || x.path.endsWith("/"));
    if(bad) throw new Error(`Invalid path: ${bad.path}`);


    const ignoreRegs = compileIgnore(el.ignorePatterns ? el.ignorePatterns.value : "");
    const kept = [];
    let ignored = 0;
    for(const f of out){
      if(isIgnoredPath(f.path, ignoreRegs)){ ignored++; continue; }
      kept.push(f);
    }
    if(ignored) log(`تم تجاهل ${ignored} ملف/مسار حسب قواعد التجاهل.`, "warning");

    return kept;

  }

  

  window.previewSelectedFiles = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }
    try{
      log("جاري تجهيز المعاينة...", "info");
      const files = await collectSelectedFiles();
      if(!files.length){
        log("لا توجد ملفات محددة.", "warning");
        return;
      }
      let total = 0;
      let maxF = {path:"", size:0};
      for(const f of files){
        total += f.blob.size || 0;
        if((f.blob.size||0) > maxF.size) maxF = {path:f.path, size:f.blob.size||0};
      }

      const list = files.slice(0, 200).map(f => `<div class="flex items-center justify-between gap-3"><span class="mono truncate">${escapeHtml(f.path)}</span><span class="text-[var(--muted)] mono">${formatBytes(f.blob.size||0)}</span></div>`).join("");
      const more = files.length > 200 ? `<div class="text-xs text-[var(--muted)] mt-2">تم إخفاء ${files.length-200} عنصر إضافي.</div>` : "";

      openModal("معاينة الملفات", `
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="pill rounded-xl p-3">
              <div class="text-[var(--muted)] text-xs">عدد الملفات</div>
              <div class="font-bold mono">${files.length}</div>
            </div>
            <div class="pill rounded-xl p-3">
              <div class="text-[var(--muted)] text-xs">الحجم الكلي</div>
              <div class="font-bold mono">${formatBytes(total)}</div>
            </div>
          </div>
          <div class="pill rounded-xl p-3 text-sm">
            <div class="text-[var(--muted)] text-xs">أكبر ملف</div>
            <div class="mono truncate">${escapeHtml(maxF.path || "—")}</div>
            <div class="text-[var(--muted)] mono">${formatBytes(maxF.size || 0)}</div>
          </div>

          <div class="divider"></div>

          <div class="h-64 overflow-auto pr-1 scrollbar space-y-2 text-sm">
            ${list}
            ${more}
          </div>
        </div>
      `);
      log("تم فتح المعاينة.", "success");
    }catch(e){
      log(e.message || String(e), "error");
    }
  };

  function escapeHtml(s){
    return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

window.startUpload = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }

    const msg = (el.commitMessage.value || "").trim() || "تحديث عبر GitUP";
    const wipe = el.wipeBeforeUpload.checked;

    // abort controller per run
    state.aborter = new AbortController();

    try{
      el.btnUpload.disabled = true;
      el.btnStop.disabled = false;
      setProgress({visible:true, text:"تحضير الملفات...", done:0, total:1});
      const files = await collectSelectedFiles();
      if(!files.length){ throw new Error("لم يتم اختيار ملفات/مجلد/ZIP."); }

      log(`عدد الملفات: ${files.length}`, "info");
      if(files.length > 800){
        log("تحذير: عدد ملفات كبير وقد يستهلك Rate Limit. يُفضل تقسيم الرفع.", "warning");
      }

      setProgress({visible:true, text:"رفع Blobs...", done:0, total:files.length});

      const commitSha = await pushFilesSingleCommit({
        owner: state.selected.owner,
        repo: state.selected.repo,
        branch: state.selected.branch,
        files,
        wipe,
        message: msg,
        onProgress: ({phase, done, total, current}) => {
          if(phase==="blob"){
            setProgress({visible:true, text:`رفع: ${current}`, done, total});
          }else if(phase==="tree"){
            setProgress({visible:true, text:"إنشاء Tree...", done:total, total});
          }else if(phase==="commit"){
            setProgress({visible:true, text:"إنشاء Commit...", done:total, total});
          }else if(phase==="ref"){
            setProgress({visible:true, text:"تحديث الفرع...", done:total, total});
          }
        }
      });

      setProgress({visible:true, text:"اكتمل.", done:files.length, total:files.length});
      log(`تم الرفع بنجاح (Commit واحد): ${commitSha}`, "success");
    }catch(e){
      if(e.name === "AbortError"){
        log("تم إيقاف العملية.", "warning");
      }else{
        log(e.message || String(e), "error");
      }
    }finally{
      el.btnUpload.disabled = false;
      el.btnStop.disabled = true;
      // keep progress visible briefly
      await sleep(600);
      setProgress({visible:false});
      state.aborter = null;
    }
  };

  // --- Wipe as single commit (empty tree) ---
  window.wipeRepoCommit = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }

    state.aborter = new AbortController();
    try{
      el.btnStop.disabled = false;
      log("جاري تنفيذ Wipe عبر Commit واحد...", "warning");
      setProgress({visible:true, text:"تحضير...", done:0, total:1});

      const {owner, repo, branch} = state.selected;
      const ref = await apiJson(`repos/${owner}/${repo}/git/ref/heads/${branch}`);
      const parentSha = ref.object.sha;

      const emptyTree = await apiJson(`repos/${owner}/${repo}/git/trees`, {
        method:"POST",
        body: JSON.stringify({ tree: [] })
      });

      const commit = await apiJson(`repos/${owner}/${repo}/git/commits`, {
        method:"POST",
        body: JSON.stringify({ message: "Wipe repository (single commit)", tree: emptyTree.sha, parents: [parentSha] })
      });

      await apiJson(`repos/${owner}/${repo}/git/refs/heads/${branch}`, {
        method:"PATCH",
        body: JSON.stringify({ sha: commit.sha, force: false })
      });

      log(`تم Wipe بنجاح: ${commit.sha}`, "success");
    }catch(e){
      if(e.name === "AbortError"){
        log("تم إيقاف العملية.", "warning");
      }else{
        log(e.message || String(e), "error");
      }
    }finally{
      el.btnStop.disabled = true;
      await sleep(600);
      setProgress({visible:false});
      state.aborter = null;
    }
  };

  // --- ZIP Download ---
  function directZipUrl(){
    if(!state.selected) return null;
    const {owner, repo, branch} = state.selected;
    return `https://github.com/${owner}/${repo}/archive/refs/heads/${branch}.zip`;
  }

  async function downloadZipLocal(){
    el.btnStop.disabled = false;
    const {owner, repo, branch} = state.selected;
    log(`تنزيل ZIP محليًا: ${owner}/${repo}@${branch}`, "warning");
    state.aborter = new AbortController();

    try{
      setProgress({visible:true, text:"جلب ref...", done:0, total:4});
      const ref = await apiJson(`repos/${owner}/${repo}/git/ref/heads/${branch}`);
      setProgress({visible:true, text:"جلب commit...", done:1, total:4});
      const commit = await apiJson(`repos/${owner}/${repo}/git/commits/${ref.object.sha}`);
      const treeSha = commit.tree.sha;

      setProgress({visible:true, text:"جلب tree...", done:2, total:4});
      const tree = await apiJson(`repos/${owner}/${repo}/git/trees/${treeSha}?recursive=1`);
      const blobs = (tree.tree || []).filter(x => x.type === "blob");

      if(blobs.length > 1500){
        log("تحذير: مستودع كبير. تنزيل ZIP محليًا قد يفشل بسبب Rate Limit. استخدم التنزيل المباشر إذا أمكن.", "warning");
      }

      const zip = new JSZip();
      for(let i=0; i<blobs.length; i++){
        const b = blobs[i];
        setProgress({visible:true, text:`تحميل: ${b.path}`, done:i, total:blobs.length});
        const blob = await apiJson(`repos/${owner}/${repo}/git/blobs/${b.sha}`);
        // content base64 with newlines sometimes
        const b64 = (blob.content || "").replace(/\n/g, "");
        const bin = atob(b64);
        const u8 = new Uint8Array(bin.length);
        for(let j=0; j<bin.length; j++) u8[j] = bin.charCodeAt(j);
        zip.file(b.path, u8);
        await sleep(SMALL_DELAY_MS);
      }

      setProgress({visible:true, text:"توليد ZIP...", done:blobs.length, total:blobs.length});
      const zipBlob = await zip.generateAsync({type:"blob"});

      const a = document.createElement("a");
      a.href = URL.createObjectURL(zipBlob);
      a.download = `${repo}_${branch}.zip`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);

      log("تم تنزيل ZIP محليًا.", "success");
    } finally {
      el.btnStop.disabled = true;
      await sleep(600);
      setProgress({visible:false});
      state.aborter = null;
    }
  }

  window.downloadZipDirect = function(){
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }
    const url = directZipUrl();
    if(!url) return;
    log("تنزيل ZIP مباشر...", "info");
    window.open(url, "_blank");
  };

  window.downloadZipLocalUI = async function(){
    if(!state.token){ log("وثّق التوكن أولاً.", "warning"); return; }
    if(!state.selected){ log("اختر مستودعاً أولاً.", "warning"); return; }
    await downloadZipLocal();
  };

    // --- Init ---
  

  // --- PWA ---
  function setInstallButtonsVisible(visible){
    const v = !!visible;
    if(el.btnInstall) el.btnInstall.classList.toggle("hidden", !v);
    if(el.btnInstallMobile) el.btnInstallMobile.classList.toggle("hidden", !v);
  }

  function showUpdateBanner(show){
    if(!el.updateBanner) return;
    if(show) el.updateBanner.classList.remove("hidden");
    else el.updateBanner.classList.add("hidden");
  }

  async function registerSW(){
    if(!("serviceWorker" in navigator)) return;
    try{
      const reg = await navigator.serviceWorker.register("./sw.js");
      state.swReg = reg;

      if(reg.waiting && navigator.serviceWorker.controller){
        showUpdateBanner(true);
      }

      reg.addEventListener("updatefound", () => {
        const nw = reg.installing;
        if(!nw) return;
        nw.addEventListener("statechange", () => {
          if(nw.state === "installed" && navigator.serviceWorker.controller){
            showUpdateBanner(true);
          }
        });
      });

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        window.location.reload();
      });
    }catch(_){
      log("تعذر تسجيل Service Worker.", "warning");
    }
  }

  window.applyUpdate = function(){
    if(state.swReg && state.swReg.waiting){
      state.swReg.waiting.postMessage({ type: "SKIP_WAITING" });
    }
  };

  window.installPWA = async function(){
    const p = state.deferredInstall;
    if(!p){
      log("التثبيت غير متاح حالياً.", "warning");
      return;
    }
    p.prompt();
    const choice = await p.userChoice.catch(()=>null);
    state.deferredInstall = null;
    setInstallButtonsVisible(false);
    if(choice && choice.outcome === "accepted"){
      log("تم بدء التثبيت.", "success");
    } else {
      log("تم إلغاء التثبيت.", "warning");
    }
  };

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    state.deferredInstall = e;
    setInstallButtonsVisible(true);
  });

  window.addEventListener("appinstalled", () => {
    setInstallButtonsVisible(false);
    log("تم تثبيت التطبيق.", "success");
  });

  window.addEventListener("offline", () => log("غير متصل بالإنترنت.", "warning"));
  window.addEventListener("online", () => log("تمت استعادة الاتصال.", "success"));

function init(){
    if(el.btnStop) el.btnStop.disabled = true;

    if(el.ignorePatterns && !el.ignorePatterns.value.trim()){
      el.ignorePatterns.value = ".git/\nnode_modules/\ndist/\nbuild/\n*.log\n.DS_Store\nThumbs.db";
    }

    if(el.branchInfo) el.branchInfo.textContent = "—";
    if(el.branchSelect) el.branchSelect.disabled = true;
    if(el.btnRefreshBranches) el.btnRefreshBranches.disabled = true;
    if(el.btnNewBranch) el.btnNewBranch.disabled = true;

    setInstallButtonsVisible(false);
    showUpdateBanner(false);
    registerSW().catch(()=>{});

    if(state.token){
      el.tokenInput.value = state.token;
      validateToken().catch(()=>{});
    } else {
      renderRepos([]);
    }

    log("جاهز.", "success");
  }
  init();

})();

</script>
</body>
</html>
